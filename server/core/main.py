from fastapi import FastAPI
from dotenv import load_dotenv
from .routers import api_router
from .db import get_db
from contextlib import asynccontextmanager
import subprocess
import sys
import os

load_dotenv()


def run_migrations():
    """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Alembic"""
    try:
        print("="*60)
        print("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...")
        print("="*60)

        migrations_dir = os.path.join(os.path.dirname(__file__), "..")
        result = subprocess.run(
            ["alembic", "upgrade", "head"],
            cwd=migrations_dir,
            capture_output=True,
            text=True
        )

        if result.returncode == 0:
            print("[OK] –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!")
        else:
            print(f"[ERR] –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π: {result.stderr}")

    except Exception as e:
        print(f"[ERR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π: {e}")


def init_test_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ"""
    from server.core.models import Domain, Enterprise

    db = next(get_db())
    try:
        domain_count = db.query(Domain).count()
        enterprise_count = db.query(Enterprise).count()

        if domain_count == 0 and enterprise_count == 0:
            print("="*60)
            print("–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
            print("="*60)

            script_path = os.path.join(os.path.dirname(__file__), "..", "generate_test_data.py")
            result = subprocess.run(
                [sys.executable, script_path],
                capture_output=True,
                text=True
            )
            if result.returncode == 0:
                print("[OK] –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!")
                print(result.stdout)
            else:
                print(f"[ERR] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {result.stderr}")
    except Exception as e:
        print(f"[ERR] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
    finally:
        db.close()


@asynccontextmanager
async def lifespan(app: FastAPI):
    run_migrations()
    init_test_data()
    yield


app = FastAPI(
    title="Enterprise API",
    description="""
# API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏, –∞–¥—Ä–µ—Å–∞–º–∏ –∏ –≤–∏–¥–∞–º–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–≠—Ç–æ API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏, –∏—Ö –∞–¥—Ä–µ—Å–∞–º–∏ –∏ –≤–∏–¥–∞–º–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üè¢ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (Enterprises)
* –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
* –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
* –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –≤–∏–¥–∞–º –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

### üìç –ê–¥—Ä–µ—Å–∞ (Addresses)
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞–º–∏ —Å –≥–µ–æ–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
* –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—à–∏—Ä–æ—Ç–∞: -90..90, –¥–æ–ª–≥–æ—Ç–∞: -180..180)
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

### üè∑Ô∏è –í–∏–¥—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Domains)
* –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ (–¥–æ 3 —É—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏)
* –ü–æ–∏—Å–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –ø–æ –≤–∏–¥—É –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö
* –ü—Ä–∏–º–µ—Ä: "–ï–¥–∞" ‚Üí "–ú—è—Å–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è" ‚Üí "–ö–æ–ª–±–∞—Å—ã"

### üîç –ì–µ–æ–ø–æ–∏—Å–∫
* **–ü–æ–∏—Å–∫ –≤ —Ä–∞–¥–∏—É—Å–µ** (`/api/enterprises/in_circle/`) - –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Ä–∞–¥–∏—É—Å–µ –æ—Ç —Ç–æ—á–∫–∏
* **–ü–æ–∏—Å–∫ –≤ –æ–±–ª–∞—Å—Ç–∏** (`/api/enterprises/in_frame/`) - –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–º—ã–∫–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∫–æ–ª–µ—Ü (EarthRing)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
* –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic
* –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
* Enterprise-—É—Ä–æ–≤–µ–Ω—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
    """,
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc",
    lifespan=lifespan
)

app.include_router(api_router)

